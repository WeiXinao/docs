# 小米商城说明

## 项目简介

JavaEE大作业——小米商城。这个项目分为静态页面和java编写的后台逻辑部分。

使用的体系结构为：MVC（Model-View-Controller）

使用的技术分为前端技术和后台技术。

## 技术说明

**前端技术**

| HTML，CSS，javascript | 前端三大金刚，是构建前端静态页面的基础。                     |
| --------------------- | ------------------------------------------------------------ |
| JQuery                | 方便javascript的编写。                                       |
| Layui                 | 易上手且开源免费的 Web 界面组件库。                          |
| SweetAlert            | 一个美观，响应，可定制，可访问（WAI-ARIA）替代JAVASCRIPT的弹出框。 |
| Ajax                  | AJAX 是一种在无需重新加载整个网页的情况下，能够更新部分网页的技术。 |

**后端技术**

| Thymeleaf  | 由Spring同公司发行的模板技术，对Spring支持较好。             |
| ---------- | ------------------------------------------------------------ |
| Spring     | Spring是Java EE编程领域的一个轻量级开源框架。                |
| Mybatis    | 一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。 |
| SpringMVC  | Spring MVC 是 Spring 提供的一个基于 MVC 设计模式的轻量级 Web 开发框架，本质上相当于Servlet。 |
| FastJson   | 用于将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。 |
| pagehelper | 方便的分页插件。                                             |
| durid      | Druid为监控而生的数据库连接池。                              |

## 项目体系结构简介

**MVC**的全名是Model View Controller，是模型(Model)－视图(view)－控制器(controller)的缩写，是一种设计模式。它是**用一种**业务逻辑、数据与界面显示分离的**方法来组织代码**，将众多的业务逻辑聚集到一个部件里面，在需要改进和个性化定制界面及用户交互的同时，不需要重新编写业务逻辑，达到减少编码的时间，提高代码复用性。



**使用的MVC的目的：**它将这些对象、显示、控制分离以提高软件的的灵活性和复用性，MVC结构可以使程序具有对象化的特征，也更容易维护。



**Model、View、Controller概述：**

模型层（Model）：指从现实世界中抽象出来的对象模型，是应用逻辑的反应；它封装了数据和对数据的操作，是实际进行数据处理的地方（模型层与数据库才有交互）

视图层（View）：是应用和用户之间的接口，它负责将应用显示给用户 和 显示模型的状态。

控制器（Controller）:控制器负责视图和模型之间的交互，控制对用户输入的响应、响应方式和流程；它主要负责两方面的动作，一是把用户的请求分发到相应的模型，二是吧模型的改变及时地反映到视图上。

在网页当中，

V即View视图是指用户看到并与之交互的界面。比如由html元素组成的网页界面，或者软件的客户端界面。MVC的好处之一在于它能为应用程序处理很多不同的视图。在视图中其实没有真正的处理发生，它只是作为一种输出数据并允许用户操纵的方式。

M即model模型是指模型表示业务规则。在MVC的三个部件中，模型拥有最多的处理任务。被模型返回的数据是中立的，模型与数据格式无关，这样一个模型能为多个视图提供数据，由于应用于模型的代码只需写一次就可以被多个视图重用，所以减少了代码的重复性。

C即controller控制器是指控制器接受用户的输入并调用模型和视图去完成用户的需求，控制器本身不输出任何东西和做任何处理。它只是接收请求并决定调用哪个模型构件去处理请求，然后再确定用哪个视图来显示返回的数据。

![](https://pic1.zhimg.com/v2-0887746ae6096d489192ea4e062acd14_r.jpg)

用户首先在界面中进行人机交互，然后请求发送到控制器，控制器根据请求类型和请求的指令发送到相应的模型，模型可以与数据库进行交互，进行增删改查操作，完成之后，根据业务的逻辑选择相应的视图进行显示，此时用户获得此次交互的反馈信息，用户可以进行下一步交互，如此循环。

需要注意的是：MVC三层结构与软件的三层结构是有区别的。MVC是一种设计模式，三层结构是软件结构，用MVC这种设计模式可以实现三层软件结构。在完整三层软件结构中 表现层包括了MVC中的表现层和控制层。而MVC中的模型层其实包括了三层软件结构的业务逻辑层、数据访问层、业务实体类（model）和共用类。软件三层结构的UI（Web）包含了MVC中的视图层（V）和控制层（C）。

## 数据库脚本

### 导入数据库脚本

数据库脚本说在目录：`xiaomi_mall\SQLScript\db_xiaomi_shop.sql`

### 连接云数据库

阿里云数据库连接URL：`jdbc:mysql://rm-bp1t46884uk5z7iyqzo.mysql.rds.aliyuncs.com:3308/db_mybatisstudy?characterEncoding=utf8&useSSL=false&serverTimezone=UTC&rewriteBatchedStatements=true
username=xiaoxin`

## 项目依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>org.xiaoxin</groupId>
  <artifactId>xiaomi_mall</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>war</packaging>

  <name>xiaomi_mall Maven Webapp</name>
  <!-- FIXME change it to the project's website -->
  <url>http://www.example.com</url>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.8</maven.compiler.source>
    <maven.compiler.target>1.8</maven.compiler.target>
  </properties>

  <dependencies>
    <!--偷懒支持：begin-->
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.22</version>
    </dependency>
    <!--偷懒支持：end-->

    <!--单元测试：begin-->
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.13.2</version>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-test</artifactId>
      <version>5.3.9</version>
    </dependency>
    <!--单元测试：end-->

    <!--日志：begin-->
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-log4j12</artifactId>
      <version>1.7.25</version>
    </dependency>
    <!--日志：end-->

    <!--spring提供springContext和Spring化：begin-->
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-context-support</artifactId>
      <version>5.3.9</version>
    </dependency>
    <!--spring提供springContext和Spring化：end-->

    <!--数据库：begin-->
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <version>8.0.20</version>
    </dependency>

    <dependency>
      <groupId>org.mybatis</groupId>
      <artifactId>mybatis</artifactId>
      <version>3.5.9</version>
    </dependency>

    <dependency>
      <groupId>org.mybatis</groupId>
      <artifactId>mybatis-spring</artifactId>
      <version>2.0.5</version>
    </dependency>

    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-jdbc</artifactId>
      <version>5.3.9</version>
    </dependency>

    <dependency>
      <groupId>com.alibaba</groupId>
      <artifactId>druid</artifactId>
      <version>1.1.22</version>
    </dependency>
    <!--数据库：end-->

    <!--切面：begin-->
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-aspects</artifactId>
      <version>5.3.9</version>
    </dependency>
    <!--切面：end-->

    <!--业务：begin-->
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-tx</artifactId>
      <version>5.3.9</version>
    </dependency>
    <!--业务：end-->

    <!--servlet支持：begin-->
    <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>javax.servlet-api</artifactId>
      <version>4.0.1</version>
      <scope>provided</scope>
    </dependency>
    <!--servlet支持：end-->

    <!--springMVC：begin-->
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-webmvc</artifactId>
      <version>5.3.0</version>
    </dependency>
    <!--springMVC：end-->

    <!--分页插件：begin-->
    <dependency>
      <groupId>com.github.pagehelper</groupId>
      <artifactId>pagehelper</artifactId>
      <version>5.3.0</version>
    </dependency>
    <!--分页插件：end-->

    <!--thymeleaf：begin-->
    <!-- https://mvnrepository.com/artifact/org.thymeleaf/thymeleaf -->
    <dependency>
      <groupId>org.thymeleaf</groupId>
      <artifactId>thymeleaf</artifactId>
      <version>3.0.12.RELEASE</version>
    </dependency>

    <dependency>
      <groupId>org.thymeleaf</groupId>
      <artifactId>thymeleaf-spring5</artifactId>
      <version>3.0.12.RELEASE</version>
    </dependency>
    <!--thymeleaf：end-->

    <!--springMVC对json的支持：begin-->
    <!-- https://mvnrepository.com/artifact/com.alibaba/fastjson -->
    <dependency>
      <groupId>com.alibaba</groupId>
      <artifactId>fastjson</artifactId>
      <version>1.2.80</version>
    </dependency>
      <dependency>
          <groupId>org.testng</groupId>
          <artifactId>testng</artifactId>
          <version>RELEASE</version>
          <scope>test</scope>
      </dependency>
      <!--springMVC对json的支持：end-->


  </dependencies>

  <build>
    <finalName>xiaomi_mall</finalName>
    <!--tomcat插件-->
    <plugins>
      <plugin>
        <groupId>org.apache.tomcat.maven</groupId>
        <artifactId>tomcat7-maven-plugin</artifactId>
        <version>2.2</version>
        <configuration>
          <path>/</path>
          <port>3666</port>
          <uriEncoding>UTF-8</uriEncoding>
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>
```

## 项目配置文件

### MyBatis

<u>db.properties</u>

```text
driver=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://rm-bp1t46884uk5z7iyqzo.mysql.rds.aliyuncs.com:3308/db_xiaomi_shop?characterEncoding=utf8&useSSL=false&serverTimezone=UTC&rewriteBatchedStatements=true
name=xiaoxin
password=WEIxinAO20014261
```

<u>mybatis-config.xml</u>

```xml
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <properties resource="mybatis/db.properties"/>

    <!--常用设置-->
    <settings>
        <!--生成主键-->
        <setting name="useGeneratedKeys" value="true"/>
        <!--命名风格映射-->
        <setting name="mapUnderscoreToCamelCase" value="true"/>
        <!--日志-->
        <setting name="logImpl" value="SLF4J"/>
    </settings>

    <typeAliases>
        <package name="com.xiaoxin.domain"/>    
    </typeAliases>

    <!--配置分页插件-->
    <plugins>
        <!-- com.github.pagehelper为PageHelper类所在包名 -->
        <plugin interceptor="com.github.pagehelper.PageInterceptor">
            <!-- 使用下面的方式配置参数，后面会有所有的参数介绍 -->
            <property name="helperDialect" value="mysql"/>
        </plugin>
    </plugins>
</configuration>
```

### Spring

<u>applicationContext.xml</u>

```xml
<?xml version="1.0" encoding="utf-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/aop
                           http://www.springframework.org/schema/aop/spring-aop.xsd
                           http://www.springframework.org/schema/tx
                           http://www.springframework.org/schema/tx/spring-tx.xsd">

    <!--启用功能-->
    <!--注解的功能-->
    <context:annotation-config/>
    <!--aop的功能-->
    <aop:aspectj-autoproxy/>
    <aop:config proxy-target-class="true"/>
    <!--配置扫描-->
    <context:component-scan base-package="com.xiaoxin">
        <!--因为applicationContext.xml中配置了一个容器，在springMVC-config.xml配置了一个容器，
        service层的代码就会加入到容器中两次，为了避免冲突，在这个大容器中，我们就不加入service 注解的bean-->
        <context:exclude-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
    </context:component-scan>

    <!--配置DataSource-->
    <!--我们使用spring的外部导入属性文件的功能-->
    <context:property-placeholder ignore-unresolvable="true" location="classpath:mybatis/db.properties" />
    <!--为了提高工作效率，使用第三方的连接池-->
    <!--Alibaba Druid-->
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
        <!--基本属性 url、user, password-->
        <property name="url" value="${url}"/>
        <property name="username" value="${name}"/>
        <property name="password" value="${password}"/>
        <!--配置监控统计拦截的filters-->
        <property name="filters" value="stat"/>
        <!--配置初始化大小，最大，最小-->
        <property name="maxActive" value="20" />
        <property name="initialSize" value="1" />
        <property name="minIdle" value="1" />
        <!--配置获取连接超时的时间-->
        <property name="maxWait" value="60000" />

        <!--配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒-->
        <property name="timeBetweenEvictionRunsMillis" value="60000" />
        <!--配置一个连接池中最小生存时间，单位是毫秒-->
        <property name="minEvictableIdleTimeMillis" value="300000" />
        <property name="testWhileIdle" value="true" />
        <property name="testOnBorrow" value="false" />
        <property name="testOnReturn" value="false" />
        <!--打开PSCache, 并且指定每个连接上的PSCache的大小-->
        <property name="poolPreparedStatements" value="true" />
        <property name="maxOpenPreparedStatements" value="20" />
    </bean>
    <!--配置SqlSessionFactory Spring化-->
    <!--mybatis-spring包下的sqlSessionFactoryBean-->
    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
        <property name="dataSource" ref="dataSource" />
        <property name="configLocation" value="classpath:mybatis/mybatis-config.xml" />
        <property name="mapperLocations" value="classpath:mapper/*Mapper.xml" />
    </bean>

    <!--为我们的接口生成代理对象，并自动加入到IOC容器中-->
    <bean id="mapperScannerConfigurer" class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory" />
        <property name="basePackage" value="com/xiaoxin/mapper" />
    </bean>

    <!--使用AOP的功能-->
    <!--配置切面-->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource" />
    </bean>

    <!--配置切入的规则，子要你在某个方法上面添加一i给注解@Transcational, 那么就会自动的将doBegin, doCommit doRollback切入到你的方法中-->
    <!--一般用于业务逻辑层-->
    <tx:annotation-driven />
</beans>
```

<u>springMVC-thymeleaf-config.xml</u>

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
                           http://www.springframework.org/schema/mvc
                           http://www.springframework.org/schema/mvc/spring-mvc-4.0.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context-4.0.xsd">

        <!--开启mvc功能-->
        <mvc:annotation-driven/>
        <!--配置扫描控制器的路径-->
        <context:component-scan base-package="com.xiaoxin.controller" />
        <!--视图解析器-->
        <bean id="templateResolver" class="org.thymeleaf.spring5.templateresolver.SpringResourceTemplateResolver" >
                <property name="prefix" value="/WEB-INF/templates/" />
                <property name="suffix" value=".html" />
                <property name="characterEncoding" value="UTF-8" />
                <property name="templateMode" value="HTML5" />
                <property name="cacheable" value="false" />
        </bean>

        <bean id="templateEngine" class="org.thymeleaf.spring5.SpringTemplateEngine" >
                <property name="templateResolver" ref="templateResolver" />
        </bean>

        <bean class="org.thymeleaf.spring5.view.ThymeleafViewResolver">
                <property name="templateEngine" ref="templateEngine" />
                <property name="order" value="1" />
                <property name="characterEncoding" value="UTF-8" />
        </bean>

        <!--可以定义一些静态变量-->
        <bean name="main" class="org.thymeleaf.spring5.view.ThymeleafView" >
                <property name="staticVariables">
                        <map>
                                <entry key="footer" value="Some company: &lt;b&gt;ACME&lt;/b&gt;" />
                        </map>
                </property>
        </bean>

        <!--修改mvc:annotation-driven 让其支持fastjson, 默认支持jackson-->
        <mvc:annotation-driven>
                <mvc:message-converters>
                        <bean class="org.springframework.http.converter.ByteArrayHttpMessageConverter" />
                        <bean class="org.springframework.http.converter.FormHttpMessageConverter" />
                        <bean class="org.springframework.http.converter.xml.SourceHttpMessageConverter" />
                        <!--这里使用阿里巴巴fastjson,不使用jackson-->
                        <bean class="com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter" />
                </mvc:message-converters>
        </mvc:annotation-driven>

        <!--避免IE在执行AJAX时， 返回JSON出现下载文件-->
        <!--支持JSON数据格式-->
        <bean id="fastJsonHttpMessageConverter" class="com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter">
                <property name="supportedMediaTypes">
                        <list>
                                <value>application/json;charset=UTF-8</value>
                                <value>text/html;charset=UTF-8</value>
                        </list>
                </property>
                <property name="fastJsonConfig" ref="fastJsonConfig" />
        </bean>

        <bean id="fastJsonConfig" class="com.alibaba.fastjson.support.config.FastJsonConfig">
                <property name="serializerFeatures">
                        <list>
                                <!--是否输出值为null的字段-->
                                <value>WriteMapNullValue</value>
                                <!--输出key时是否使用双引号-->
                                <value>QuoteFieldNames</value>
                                <!--如果字段为null, 输出0，而非null-->
                                <value>WriteNullNumberAsZero</value>
                                <!--字符类型如果为null,输出为"", 而非null-->
                                <value>WriteNullStringAsEmpty</value>
                                <!--Boolean字段如果为null, 输出为false, 而非null-->
                                <value>WriteNullBooleanAsFalse</value>
                                <!--null String 不输出-->
                                <value>WriteNullStringAsEmpty</value>
                                <!--Date日期转换器-->
                                <value>WriteDateUseDateFormat</value>
                                <!--禁用FastJson引用循环-->
                                <value>DisableCircularReferenceDetect</value>
                        </list>
                </property>
        </bean>


        <!--静态资源放过-->
        <mvc:default-servlet-handler/>

        <!--
        <mvc:resources location="static/css/" mapping="static/css/**" />
        <mvc:resources location="static/fonts/" mapping="static/fonts/**" />
        <mvc:resources location="static/images/" mapping="static/images/**" />
        <mvc:resources location="static/js/" mapping="static/js/**" />
        <mvc:resources location="static/picture/" mapping="static/picture/**" />
        -->

        <!--配置拦截器-->


        <mvc:interceptors>
                <mvc:interceptor>
                        <!--拦截所有-->
                        <mvc:mapping path="/**"/>
                        <!--不拦截的配置-->
                        <mvc:exclude-mapping path="/static/**"/>
                        <mvc:exclude-mapping path="/admin/**"/>
                        <bean class="com.xiaoxin.interceptor.AuthInterceptor"/>
                </mvc:interceptor>
        </mvc:interceptors>

</beans>
```

### Log4J

<u>log4j.properties</u>

```text
#输出到什么地方 控制台 日志文件
#哪些内容要输出
#############
# 输出到控制台
#############
##只输出不低于该级别的日志信息DEBUG < INFO < WARN < ERROR < FATAL
# log4j.rootLogger日志输出类别和级别：
# WARN：默认的日志级别 CONSOLE：输出位置自己定义的一个名字 logfile：输出位置自己定义的一个名字
log4j.rootLogger=DEBUG,CONSOLE,logfile
# 配置CONSOLE输出到控制台
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender 
# 配置CONSOLE设置为自定义布局模式
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout 
# 配置CONSOLE日志的输出格式 [frame] 2019-08-22 22:52:12,000 %r耗费毫秒数 %p日志的优先级 %t线程名 %C所属类名通常为全类名 %L代码中的行号 %x线程相关联的NDC %m日志 %n换行
log4j.appender.CONSOLE.layout.ConversionPattern=[console] %d{yyyy-MM-dd HH:mm:ss,SSS} - %-4r %-5p [%t] %C:%L %x - %m%n


################
# 输出到日志文件中
################
# 配置logfile输出到文件中 文件大小到达指定尺寸的时候产生新的日志文件
log4j.appender.logfile=org.apache.log4j.RollingFileAppender
# 保存编码格式
log4j.appender.logfile.Encoding=UTF-8
# 输出文件位置此为项目根目录下的logs文件夹中
log4j.appender.logfile.File=./root.log
# 后缀可以是KB,MB,GB达到该大小后创建新的日志文件
log4j.appender.logfile.MaxFileSize=10MB
# 设置滚定文件的最大值3 指可以产生root.log.1、root.log.2、root.log.3和root.log四个日志文件
log4j.appender.logfile.MaxBackupIndex=3 
# 配置logfile为自定义布局模式
log4j.appender.logfile.layout=org.apache.log4j.PatternLayout
log4j.appender.logfile.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss} %F %p %m%n


##########################
# 对不同的类输出不同的日志文件
##########################
# com.xiaoxin包下的日志单独输出
log4j.logger.com.xiaoxin=ERROR
```


##项目模块说明

### 注册

![image-20220602003330268](https://s2.loli.net/2022/06/02/Wc6JYsHkLND2wEM.png)

#### 访问注册页面

```java
@RequestMapping(value="/reg")
public String regPage(HttpServletRequest request, HttpServletResponse response) {
    return "reg";
}
```

#### 注册相关Service

```java
@Override
@Transactional
public int doReg(String username, String password, String repassword) {
    log.info("username:{}, password:{}, repassword:{}", username, password, repassword)    if (password == null || !password.equals(repassword)) {
        return -2;
    }

    User user = new User();
    if (username.contains("@")) {
        user.setEmail(username);
    } else {
        user.setMobile(username);
    }

    User user1 = userMapper.selectUserByMobileOrEmailWithoutPassword(user);
    if (user1 != null) {
        return -3;
    }

    user.setUsername(MD5Utils.getMD5Value(username));
    user.setPassword(password);
    SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd");
    String formatDate = simpleDateFormat.format(new Date());
    user.setRegDate(formatDate);
    // 表示该用户是否是会员
    user.setFlag(0);
    int i = userMapper.insertSelective(user);
    log.info("inserted user:{}",user);
    if (i > 0) return 1;
    else return -1;
}
```

#### 注册Controller

```java
@RequestMapping(value="/doReg", method=RequestMethod.POST)
public ModelAndView doReg(String username, String password, String repassword, HttpServletRequest request, HttpServletResponse response) {
    int code = userService.doReg(username, password, repassword);
    ModelAndView modelAndView = new ModelAndView();

    if (code == 1) {
        modelAndView.addObject("username", username);
        modelAndView.addObject("password", password);
        modelAndView.setViewName("login");

    } else if(code == -1) {
        modelAndView.addObject("regErrorMsg", "注册失败");
        modelAndView.setViewName("reg");
    } else if (code == -2) {
        modelAndView.addObject("regErrorMsg", "密码和确认密码不一致");
        modelAndView.setViewName("reg");
    } else if (code == -3) {
        modelAndView.addObject("regErrorMsg", "用户已存在，请登录");
        modelAndView.setViewName("reg");
    }

    return modelAndView;
}
```

### 登录

![image-20220602094429352](https://s2.loli.net/2022/06/02/AIJ8YlNcjiS5qOy.png)

#### 访问登录页面

```java
@RequestMapping(value="/login")
public String login(HttpServletRequest request, HttpServletResponse response) {
        return "login";
}
```

#### 登录相关Service

```java
@Override
@Transactional
public User doLogin(User user) {
    return userMapper.selectUserByMobileOrEmail(user);
}
```



#### 登录相关Controller

```java
@RequestMapping(value="/doLogin", method=RequestMethod.POST)
public ModelAndView doLogin(User user, boolean autologin, HttpServletRequest request, HttpServletResponse response) {
    log.info("loginingUser:{}",user);
    log.info("autologin:{}",autologin);

    user.setMobile(user.getUsername());
    user.setEmail(user.getUsername());

    ModelAndView modelAndView = new ModelAndView();
    HttpSession session = request.getSession();
    User loginUser = userService.doLogin(user);



    if (loginUser != null) {
        if (autologin) {
            Cookie cookie = new Cookie("username", loginUser.getUsername());
            cookie.setMaxAge(3600 * 24 * 5);
            response.addCookie(cookie);
        }

        session.setAttribute("loginUser", loginUser);
        modelAndView.setViewName("redirect:/");
        return modelAndView;
    } else {
        modelAndView.addObject("loginErrorMsg", "用户名或密码错误");
        modelAndView.addObject("username", user.getUsername());
        modelAndView.addObject("password", user.getPassword());
        modelAndView.setViewName("login");
        return modelAndView;
    }
}
```

### 主页

![image-20220602095231738](https://s2.loli.net/2022/06/02/7LYXmzOai5Ctk6V.png)

#### 主页相关Service

```java
@Override
public User getUserByUsername(User user) {
    return userMapper.selectUserByUsername(user);
}
```

```java
@Override
public int countCartByUid(int uid) {
    return cartMapper.countCart(uid);
}
```

```java
@Override
public Map<String, List<Item>> showCatalogMerchandise() {
    List<Item> clothes = itemMapper.selectByCatalog("服饰");

    List<Item> mobilePhones = itemMapper.selectByCatalog("手机");
    List<Item> appliances = itemMapper.selectByCatalog("家电");
    List<Item> digital = new ArrayList<>();
    digital.addAll(mobilePhones);
    digital.addAll(appliances);

    List<Item> snacks = itemMapper.selectByCatalog("零食");

    int clothesShowNum = 0;
    int digitalShowNum = 0;
    int snacksShowNum = 0;
    if (clothes.size() > 4) {
        clothesShowNum = clothes.size() / 4 * 4;
    }
    if (digital.size() > 4) {
        digitalShowNum = digital.size() / 4 * 4;
    }
    if (snacks.size() > 4) {
        snacksShowNum = snacks.size() / 4 * 4;
    }

    Map<String, List<Item>> showItems = new HashMap<>();

    ArrayList<Item> showClothes = new ArrayList<>();
    ArrayList<Item> showDigital = new ArrayList<>();
    ArrayList<Item> showSnacks = new ArrayList<>();

    for (int i = 0; i < clothesShowNum; i++) {
        showClothes.add(clothes.get(i));
    }
    showItems.put("clothes", showClothes);

    for (int i = 0; i < digitalShowNum; i++) {
        showDigital.add(digital.get(i));
    }
    showItems.put("digital", showDigital);

    for (int i = 0; i < snacksShowNum; i++) {
        showSnacks.add(snacks.get(i));
    }
    showItems.put("snacks", showSnacks);

    return showItems;
}
```

#### 主页相关Controller

```java
    @RequestMapping("/")
    public ModelAndView IndexShowItem(HttpSession session, HttpServletRequest request) {
        Cookie[] cookies = request.getCookies();
        if (cookies != null && cookies.length > 0) {
            for (Cookie cookie : cookies) {
                if ("username".equals(cookie.getName())) {
                    User user = new User();
                    user.setUsername(cookie.getValue());
                    User completeUser = userService.getUserByUsername(user);
                    session.setAttribute("loginUser",completeUser);
                    break;
                }
            }
        }



        User loginUser = (User)session.getAttribute("loginUser");
        if (loginUser != null) {
            int cartNum = shoppingService.countCartByUid(loginUser.getUid());
            // 购物车中商品的数量
            session.setAttribute("cartNum", cartNum);
        } else {
            session.setAttribute("cartNum", 0);
        }
        int cartNum = (int) session.getAttribute("cartNum");
        log.info("cartNum:{}", cartNum);

        ModelAndView modelAndView = new ModelAndView();
        Map<String, List<Item>> showItems = itemService.showCatalogMerchandise();
        modelAndView.addObject("showItems", showItems);
        modelAndView.setViewName("index");
        return modelAndView;
    }
}
```

### 商品详情

![image-20220602100616529](https://s2.loli.net/2022/06/02/oESvpnuAk42Yr5a.png)

#### 商品详情相关Service

```java
@Override
public Item getGoodDetail(long id) {
    return itemMapper.selectByPrimaryKey(id);
}
```

```java
@RequestMapping(value="/messAdd", method=RequestMethod.POST)
@ResponseBody
CartItemVO messAdd(@RequestBody Cart cart, HttpSession session, HttpServletResponse response) {
    log.info("cart:{}", cart);
    boolean isSuccess = shoppingService.addCart(cart);
    int cartNum = 0;
    User loginUser = (User) session.getAttribute("loginUser");
    if (loginUser != null) {
        cartNum = shoppingService.countCartByUid(loginUser.getUid());
    }
    session.setAttribute("cartNum", cartNum);
    return new CartItemVO(isSuccess, cartNum);
}
```

```java
@Override
public List<Address> getAddressByUid(Integer uid) {
    List<Address> addresses = addressMapper.selectAddressByUid(uid);
    return addresses;
}
```

#### 商品详情相关Controller

```java
@Controller
public class MessController {
    @Autowired
    ItemService itemService;

    @RequestMapping(value="/goodsMess/{id}")
    public ModelAndView showMess(@PathVariable("id") long id) {
        ModelAndView modelAndView = new ModelAndView();
        Item goodDetail = itemService.getGoodDetail(id);
        modelAndView.addObject("goodDetail", goodDetail);

        modelAndView.setViewName("goodsMess");
        return modelAndView;
    }
}
```

```java
@RequestMapping(value="/messAdd", method=RequestMethod.POST)
@ResponseBody
CartItemVO messAdd(@RequestBody Cart cart, HttpSession session, HttpServletResponse response) {
    log.info("cart:{}", cart);
    boolean isSuccess = shoppingService.addCart(cart);
    int cartNum = 0;
    User loginUser = (User) session.getAttribute("loginUser");
    if (loginUser != null) {
        cartNum = shoppingService.countCartByUid(loginUser.getUid());
    }
    session.setAttribute("cartNum", cartNum);
    return new CartItemVO(isSuccess, cartNum);
}
```

```java
@RequestMapping(value = "/buy")
String buy(Model model, HttpSession session) {
    User loginUser = (User) session.getAttribute("loginUser");
    if (loginUser != null) {
        List<Address> address = addressService.getAddressByUid(loginUser.getUid());
        model.addAttribute("addresses", address);
    }
    return "buy";
}
```

### 搜索

![image-20220602102324682](https://s2.loli.net/2022/06/02/5qSzFigcHNjOA2k.png)

#### 搜索相关Service

```java
@Override
public List<Catalog> getAllCatalogService() {
    return catalogMapper.selectAllCatalogs();
}
```

```java
@Override
public PageInfo<Item> showItemByCatalog(long cid, int sortIndex, int pageNum, int pageSize) {
    Catalog catalog = catalogMapper.selectByPrimaryKey(cid);

    PageHelper.startPage(pageNum, pageSize);

    List<Item> items = itemMapper.selectByCatalog(catalog.getCatalog());
    if (sortIndex == 1) {
        Collections.sort(items, new Comparator<Item>() {
            @Override
            public int compare(Item o1, Item o2) {
                return o1.getPrice() - o2.getPrice();
            }
        });
    } else if (sortIndex == 2) {
        Collections.sort(items, new Comparator<Item>() {
            @Override
            public int compare(Item o1, Item o2) {
                return o2.getPrice() - o1.getPrice();
            }
        });
    } else if (sortIndex == 3) {
        Collections.sort(items, new Comparator<Item>() {
            @Override
            public int compare(Item o1, Item o2) {
                return o2.getBuyCount() - o1.getBuyCount();
            }
        });
    }


    return new PageInfo<>(items, 5);
}
```

```java
@Override
public List<Item> searchItems(String str) {
    return itemMapper.selectItemAdjective(str);
}
```

#### 搜索相关Controller

```java
@RequestMapping(value = "/search/{name}/{pageNum}/{pageSize}/{cid}/{sortIndex}")
public ModelAndView doSearch(@PathVariable("pageNum")int pageNum,
                             @PathVariable("pageSize")int pageSize,
                             @PathVariable("cid")int cid,
                             @PathVariable("sortIndex") int sortIndex,
                             @PathVariable("name")String name) {

    try {
        name = URLDecoder.decode(name, "utf-8");
    } catch (UnsupportedEncodingException e) {
        e.printStackTrace();
    }

    ModelAndView modelAndView = new ModelAndView();
    List<Catalog> catalogs = catalogService.getAllCatalogService();
    modelAndView.addObject("catalogs", catalogs);

    PageInfo<Item> itemPageInfo = itemService.showItemByCatalog(cid, sortIndex, pageNum, pageSize);
    modelAndView.addObject("itemPageInfo", itemPageInfo);

    modelAndView.addObject("sortIndex", sortIndex);
    modelAndView.addObject("cidTmp", cid);

    List<Item> searchResults = itemService.searchItems(name);
    modelAndView.addObject("searchResults", searchResults);

    modelAndView.setViewName("search");
    return modelAndView;
}
```

### 商品列表

![image-20220602103357032](https://s2.loli.net/2022/06/02/nxoyIaCDheA43Rw.png)

#### 商品列表相关Service

```java
@Override
public PageInfo<Item> showItemByCatalog(long cid, int sortIndex, int pageNum, int pageSize) {
    Catalog catalog = catalogMapper.selectByPrimaryKey(cid);

    PageHelper.startPage(pageNum, pageSize);

    List<Item> items = itemMapper.selectByCatalog(catalog.getCatalog());
    if (sortIndex == 1) {
        Collections.sort(items, new Comparator<Item>() {
            @Override
            public int compare(Item o1, Item o2) {
                return o1.getPrice() - o2.getPrice();
            }
        });
    } else if (sortIndex == 2) {
        Collections.sort(items, new Comparator<Item>() {
            @Override
            public int compare(Item o1, Item o2) {
                return o2.getPrice() - o1.getPrice();
            }
        });
    } else if (sortIndex == 3) {
        Collections.sort(items, new Comparator<Item>() {
            @Override
            public int compare(Item o1, Item o2) {
                return o2.getBuyCount() - o1.getBuyCount();
            }
        });
    }


    return new PageInfo<>(items, 5);
}
```

```java
@Override
public List<Catalog> getAllCatalogService() {
    return catalogMapper.selectAllCatalogs();
}
```

#### 商品列表相关Controller

```java
@RequestMapping("/goodsList/{pageNum}/{pageSize}/{cid}/{sortIndex}")
public ModelAndView enterGoodsList(@PathVariable("pageNum")int pageNum,
                                   @PathVariable("pageSize")int pageSize,
                                   @PathVariable("cid")int cid,
                                   @PathVariable("sortIndex") int sortIndex) {
    ModelAndView modelAndView = new ModelAndView();
    List<Catalog> catalogs = catalogService.getAllCatalogService();
    modelAndView.addObject("catalogs", catalogs);

    PageInfo<Item> itemPageInfo = itemService.showItemByCatalog(cid, sortIndex, pageNum, pageSize);
    modelAndView.addObject("itemPageInfo", itemPageInfo);

    modelAndView.addObject("sortIndex", sortIndex);
    modelAndView.addObject("cidTmp", cid);

    modelAndView.setViewName("goodsList");
    return modelAndView;
}
```

### 购物车

![image-20220602104332209](https://s2.loli.net/2022/06/02/VMKnZxSBGbXcdf2.png)

#### 购物车相关Service

```java
package com.xiaoxin.service.impl;

import com.xiaoxin.domain.Cart;
import com.xiaoxin.domain.Item;
import com.xiaoxin.mapper.CartMapper;
import com.xiaoxin.mapper.ItemMapper;
import com.xiaoxin.service.ShoppingService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.RequestBody;

import java.util.List;

/**
 * @author XiaoXin
 * @date 2022/5/7 - 10:37
 */
@Slf4j
@Service
public class ShoppingServiceImpl implements ShoppingService {
   @Autowired
   CartMapper cartMapper;
   @Autowired
   ItemMapper itemMapper;

   @Override
   public int countCartByUid(int uid) {
      return cartMapper.countCart(uid);
   }

   @Override
   public List<Cart> listCartByUid(int uid) {
      return cartMapper.selectCartByUid(uid);
   }

   /**
    * -1: 错误，购买数量不能小于0
    * -2: 错误，库存不够
    * -3: 错误，表更新失败
    * 0: 正确
    * @param cart
    * @return
    */
   @Override
   @Transactional
   public int updateCart(Cart cart) {
      Item item = itemMapper.selectByPrimaryKey(cart.getId());
      // 总数
      Integer number = item.getNumber();
      // 已经被购买的数量
      Integer buyNum = item.getBuyNum();
      log.info("number:{}", number);
      log.info("buyNum:{}", buyNum);
      // 错误，购买数量小于0
      if(cart.getBuynum() < 0) {
         return -1;
      }
      // 错误，库存
      if (cart.getBuynum() + buyNum > number) {
         return -2;
      }
      // 系统错误
      int cartRow = cartMapper.updateByPrimaryKeySelective(cart);
      if (cartRow <= 0) {
         return -3;
      }
      return 0;
   }

   @Override
   @Transactional
   public boolean deleteCart(@RequestBody List<Integer> cidList) {
      int row = cartMapper.deleteCartsById(cidList);
      return row > 0;
   }

   @Override
   public boolean addCart(Cart cart) {
      int row = cartMapper.insert(cart);
      return row > 0;
   }
}
```

```java
package com.xiaoxin.service.impl;

import com.xiaoxin.domain.OrderSub;
import com.xiaoxin.mapper.OrderSubMapper;
import com.xiaoxin.service.OrderSubService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * @author XiaoXin
 * @date 2022/5/15 - 15:34
 */

@Service
public class OrderSubServiceImpl implements OrderSubService {
    @Autowired
    OrderSubMapper orderSubMapper;

    @Transactional
    @Override
    public boolean addAllOrderSub(List<OrderSub> orderSubs) {
        int row = orderSubMapper.insertAllOrderSubs(orderSubs);
        return row > 0;
    }

    @Override
    public List<OrderSub> getAllOrderSub() {
        return orderSubMapper.selectAllOrderSub();
    }

    @Override
    public List<OrderSub> getOrderSubByOid(String oid) {
        return orderSubMapper.selectOrderSubsByOid(oid);
    }
}
```



#### 购物车相关Controller

```java
package com.xiaoxin.controller;

import com.alibaba.fastjson.JSON;
import com.xiaoxin.Utils.UUIDUtil;
import com.xiaoxin.domain.Cart;

import com.xiaoxin.domain.OrderSub;
import com.xiaoxin.domain.User;
import com.xiaoxin.service.OrderSubService;
import com.xiaoxin.service.ShoppingService;
import com.xiaoxin.vo.BuyVO;
import com.xiaoxin.vo.CartItemVO;
import lombok.extern.slf4j.Slf4j;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;


import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @author XiaoXin
 * @date 2022/5/5 - 20:16
 */

@Slf4j
@Controller
public class ShoppingController {
    @Autowired
    ShoppingService shoppingService;
    @Autowired
    OrderSubService orderSubService;

    /**
     * 进入购物车页面
     * @param session
     * @return
     */
    @RequestMapping("/shopping")
    String enterShopping(HttpSession session) {
        User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser != null) {
            List<Cart> carts = shoppingService.listCartByUid(loginUser.getUid());
            session.setAttribute("carts", carts);
        }

        return "shopping";
    }

    /**
     * 添加商品，添加商品数量 + 1 或 商品数量 - 1
     * @param cart
     * @param session
     * @param response
     */
    @RequestMapping(value="/shoppingAdd", method= RequestMethod.POST)
    void updateShopping(Cart cart, HttpSession session, HttpServletResponse response) {
        try {
            int statusCode = shoppingService.updateCart(cart);
            if (statusCode == 0) {
                List<Cart> carts = shoppingService.listCartByUid(18);
                session.setAttribute("carts", carts);
            }
            PrintWriter writer = response.getWriter();
            writer.print(statusCode);
            writer.flush();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @ResponseBody
    @RequestMapping(value="/cartDel", method = RequestMethod.POST)
    CartItemVO deleteShoppingCart(String cids, HttpSession session) {
            log.info("delete {}", cids);
            String[] cidsStr = cids.trim().split(" ");
            int[] cidArray = Arrays.asList(cidsStr).stream().mapToInt(Integer::parseInt).toArray(); // 将 String 数组转为 int 数组
            List<Integer> cidIntegerList = Arrays.stream(cidArray).boxed().collect(Collectors.toList()); // 将 int 数组装化为 List<Integer>
            cidIntegerList.forEach((cid)->{log.info("cid:{}",cid);});
            boolean b = false;
            if (cidIntegerList != null && cidIntegerList.size() > 0) {
                b = shoppingService.deleteCart(cidIntegerList);
            }
            log.info("b:{}", b);
            int cartNum = 0;
            User loginUser = (User) session.getAttribute("loginUser");
            if (loginUser != null) {
                cartNum = shoppingService.countCartByUid(loginUser.getUid());
            }
            session.setAttribute("cartNum", cartNum);
            return new CartItemVO(b, cartNum);
    }


    @RequestMapping(value="/messAdd", method=RequestMethod.POST)
    @ResponseBody
    CartItemVO messAdd(@RequestBody Cart cart, HttpSession session, HttpServletResponse response) {
        log.info("cart:{}", cart);
        boolean isSuccess = shoppingService.addCart(cart);
        int cartNum = 0;
        User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser != null) {
            cartNum = shoppingService.countCartByUid(loginUser.getUid());
        }
        session.setAttribute("cartNum", cartNum);
        return new CartItemVO(isSuccess, cartNum);
    }

    @RequestMapping(value="/payCart", method=RequestMethod.POST)
    String buy(@RequestBody String buyInfo, HttpSession session) {
        BuyVO buyVO = JSON.parseObject(buyInfo, BuyVO.class);
        String oid = UUIDUtil.getOid();
        log.info("oid:{}" + oid);
        ArrayList<OrderSub> orderSubs = new ArrayList<>();
        for (Cart buyItem : buyVO.getBuyItems()) {
            orderSubs.add(new OrderSub(oid, buyItem.getId(),
                                        buyItem.getName(),
                                        buyItem.getPrice(),
                                        buyItem.getBuynum(),
                                        buyItem.getSum(),
                                        buyItem.getPic()));
        }
        orderSubService.addAllOrderSub(orderSubs);
        session.setAttribute("buyInfo", buyVO);
        String oidString = oid.toString();
        session.setAttribute("oid", oidString);
        return "buy";
    }
}
```

### 购买

![image-20220602104809712](https://s2.loli.net/2022/06/02/ImKnrB9eRly1Jgt.png)

#### 购买相关Service

```java
@Override
public List<Address> getAddressByUid(Integer uid) {
    List<Address> addresses = addressMapper.selectAddressByUid(uid);
    return addresses;
}
```

#### 购买相关Controller

```java
@RequestMapping(value = "/buy")
String buy(Model model, HttpSession session) {
    User loginUser = (User) session.getAttribute("loginUser");
    if (loginUser != null) {
        List<Address> address = addressService.getAddressByUid(loginUser.getUid());
        model.addAttribute("addresses", address);
    }
    return "buy";
}
```

### 收货地址

![image-20220602105749638](https://s2.loli.net/2022/06/02/7tLkEXFAnwq348R.png)

####收货地址相关Service 

```java
package com.xiaoxin.service.impl;

import com.xiaoxin.domain.Address;
import com.xiaoxin.mapper.AddressMapper;
import com.xiaoxin.service.AddressService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * @author XiaoXin
 * @date 2022/5/14 - 11:53
 */

@Service
public class AddressServiceImpl implements AddressService {
    @Autowired
    AddressMapper addressMapper;

    @Override
    public List<Address> getAllAddress() {
        return addressMapper.selectAllAddress();
    }

    @Transactional
    @Override
    public boolean addAddress(Address address) {
        int row = addressMapper.insert(address);
        return row > 0;
    }

    @Transactional
    @Override
    public boolean modifyAddress(Address address) {
        int row = addressMapper.updateByPrimaryKey(address);
        return row > 0;
    }

    @Transactional
    @Override
    public boolean delAddress(Integer aid) {
        int row = addressMapper.deleteByPrimaryKey(aid);
        return row > 0;
    }

    @Override
    public List<Address> getAddressByUid(Integer uid) {
        List<Address> addresses = addressMapper.selectAddressByUid(uid);
        return addresses;
    }

    @Override
    public Address getAddressByAid(Integer aid) {
        return addressMapper.selectByPrimaryKey(aid);
    }
}
```

#### 收货地址相关Controller

```java
@Slf4j
@Controller
public class AddressController {
    @Autowired
    AddressService addressService;

    @RequestMapping("/userCenter")
    String userCenter() {
        return "userCenter";
    }

    @RequestMapping("/userAddress")
    String userAddress() {
        return "userAddress";
    }

    @RequestMapping("/shouhuo")
    String shouhuo() {
        return "shouhuo";
    }

    @RequestMapping("/shouhuoUpdate")
    String shouhuoUpdate() {
        return "shouhuoUpdate";
    }

    @RequestMapping("/shouhuoBuy")
    String shouhuoBuy() {
        return "shouhuoBuy";
    }

    @RequestMapping("/listAddress")
    @ResponseBody
    AddressVO list(HttpSession session) {
        User loginUser = (User) session.getAttribute("loginUser");
        List<Address> allAddress;
        if (loginUser != null) {
            allAddress = addressService.getAddressByUid(loginUser.getUid());
        } else {
            allAddress = new ArrayList<>();
        }
        Integer count = allAddress.size();
        return new AddressVO(0, "", count, allAddress);
    }

    @RequestMapping(value = "/addAddress", method = RequestMethod.POST)
    @ResponseBody
    boolean add(@RequestBody Address address) {
        return addressService.addAddress(address);
    }

    @RequestMapping(value = "/updateAddress", method = RequestMethod.POST)
    @ResponseBody
    boolean update(@RequestBody Address address) {
        log.info("update address:{}", address);
        return addressService.modifyAddress(address);
    }

    @RequestMapping(value = "/deleteAddress", method = RequestMethod.POST)
    @ResponseBody
    boolean del(@RequestBody Integer aid) {
        log.info("aid:{}",aid);
        return addressService.delAddress(aid);
    }
}
```

### 订单

![image-20220602110111241](https://s2.loli.net/2022/06/02/zWeTiCIjVXBvPOJ.png)

#### 用户订单相关Service

```java
package com.xiaoxin.service.impl;

import com.xiaoxin.domain.OrderMain;
import com.xiaoxin.mapper.OrderMainMapper;
import com.xiaoxin.service.OrderMainService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * @author XiaoXin
 * @date 2022/5/15 - 21:25
 */

@Service
public class OrderMainServiceImpl implements OrderMainService {
    @Autowired
    OrderMainMapper orderMainMapper;

    @Transactional
    @Override
    public boolean addMainOrder(OrderMain orderMain) {
        int row = orderMainMapper.insert(orderMain);
        return row > 0;
    }

    @Override
    public List<OrderMain> getOrderMainByPay(int isPay) {
        return orderMainMapper.selectAllOrderMainIsPay(isPay);
    }

    @Override
    @Transactional
    public boolean modifyIsPay(OrderMain orderMain) {
        int i = orderMainMapper.updateIsPay(orderMain);
        return i > 0;
    }

    @Override
    public List<OrderMain> getAllOrderMain() {
        return orderMainMapper.selectAllOrderMain();
    }
}
```

#### 用户订单相关Controller

```java
package com.xiaoxin.controller;

import java.util.List;
import com.xiaoxin.domain.OrderMain;
import com.xiaoxin.service.OrderMainService;
import com.xiaoxin.vo.OrderMainVO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import javax.servlet.http.HttpServletRequest;

/**
 * @author XiaoXin
 * @date 2022/5/16 - 8:45
 */

@Controller
public class UserOrderController {
    @Autowired
    OrderMainService orderMainService;

    /**
     * 用户订单
     */
    @RequestMapping("/userOrder")
    String userOrder() {
        return "userOrder";
    }

    /**
     * 订单详情
     */
    @RequestMapping("/orderDetail")
    String orderDetail() {
        return "orderDetail";
    }

    /**
     * 已付款（带发货订单）
     */
    @RequestMapping("/userOrderPaid")
    String userOrderPaid() {
        return "userOrderPaid";
    }

    /**
     *  未付款订单
     */
    @RequestMapping("/userOrderNotPaid")
    String userOrderNotPaid() {
        return "userOrderNotPaid";
    }

    /**
     * 返回所有的订单
     */
    @RequestMapping("/getAllOrderMain")
    @ResponseBody
    OrderMainVO getAllOrderMain(HttpServletRequest response) {
        List<OrderMain> allOrderMain = orderMainService.getAllOrderMain();
        return new OrderMainVO(0, "", allOrderMain.size(), allOrderMain);

    }

    /**
     *  返回已经支付的订单
     */
    @RequestMapping("/getAllOrderMainPaid")
    @ResponseBody
    OrderMainVO getAllOrderMainPaid() {
        List<OrderMain> orderMainByPay = orderMainService.getOrderMainByPay(1);
        return new OrderMainVO(0, "", orderMainByPay.size(), orderMainByPay);
    }

    /**
     * 返回未支付的订单
     */
    @RequestMapping("/getAllOrderMainNotPaid")
    @ResponseBody
    OrderMainVO getAllOrderMainNotPaid() {
        List<OrderMain> orderMainByPay = orderMainService.getOrderMainByPay(0);
        return new OrderMainVO(0, "", orderMainByPay.size(), orderMainByPay);
    }
}
```



## 常用代码片段

### spring-test

```java
@Slf4j  
@RunWith(SpringJUnit4ClassRunner.class)  
@ContextConfiguration("classpath:spring/applicationContext.xml")
```

### sweatalert 

```javascript
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
```

```javascript
swal({  
   title: "确定要删除么?",  
   text: "一旦删除，购物车中相关商品信息将无法恢复",  
   icon: "warning",  
   buttons: true,  
   dangerMode: true,  
}).then((willDelete) => {  
   if (willDelete) {  
      $.post("/cartDel",  
            {  
               "cids": cids  
            },  
            function(data, status) {  
               if (status) {  
                  if (data.success === true) {  
                     var header = document.getElementsByTagName("iframe")[0].contentWindow;  
                     var shoppingNumEle = header.document.getElementById("my-shopping-num");  
                     shoppingNumEle.innerText = data.cartNum;  
  
                     var cidList = cids.trim().split(" ");  
                     for (let j = 0; j < cidList.length; j++) {  
                        $("#tr" + cidList[j]).remove()  
                     }  
                  }               
			   }            
	  }, "json");}  
});
```

### shouhuo.html

```js
layui.use('form', function() {  
   var form = layui.form;  
   var index = parent.layer.getFrameIndex(window.name); //获取窗口索引  
   //监听提交  
   form.on('submit(formDemo)', function(data) {  
      var uid = [[${session.loginUser != null?session.loginUser.uid:null}]]  
      var realname = data.field.realname;  
      var mobile = data.field.mobile  
      var province = data.field.province  
      var city = data.field.city  
      var zone = data.field.zone  
      var street = data.field.street  
      var address = {};  
      address.uid = uid;  
      address.realname = realname;  
      address.mobile = mobile;  
      address.province = province;  
      address.city = city;  
      address.zone = zone;  
      address.street = street;  
      var flag = "成功";  
      $.ajax({  
         type: "POST",  
         url: "/addAddress",  
         data: JSON.stringify(address),  
         dataType: "json",  
         contentType: "application/json;charset=UTF-8",  
         success: function (data) {  
            if (data === true) {  
               flag = "失败";  
            }  
         }      
	  });  
      parent.location.reload();  
   });  
});
```

### layui生成表格

```html
<table class="layui-table" id="userAddressTable" lay-filter="addressTable" lay-skin="line">
</table>
```

```html
<script type="text/html" id="operateBar">  
   <button class="layui-btn layui-btn-sm layui-btn-danger">  
      <i class="layui-icon layui-icon-edit" lay-event="edit"></i>  
   </button>  
   <button class="layui-btn layui-btn-sm layui-btn-primary">  
      <i class="layui-icon layui-icon-delete" lay-event="del"></i>  
   </button>  
</script>
```

```html
<script th:inline=none>  
   //点击添加新地址事件  
   $('#addAddress').on('click', function(){  
      layer.open({  
         type: 2,  
         area: ['700px', '550px'],  
         fixed: true, //不固定  
         maxmin: false,  
         title: '新增收货地址',  
         anim:1,  
         shadeClose:true,  
         content: 'shouhuo',  
      });  
   });  
  
   // 构建一个table实例  
   layui.use(["table", "form"], function() {  
      var table = layui.table;  
      var form = layui.form;  
  
      // 加载table实例  
      table.render({  
         elem: "#userAddressTable", // elem属性用来绑定容器的id属性值  
         url: "/listAddress", // 数据接口  
         cols: [[  
            // 设置序列号  
            {field: "number", type: "numbers"},  
            {field: 'aid', title: '地址编号', hide: true},  
            {field: 'uid', title: '用户编号', hide: true},  
            {field: 'realname', title: '真实姓名'},  
            {field: 'province', title: '省份'},  
            {field: 'city', title: '城市'},  
            {field: 'zone', title: '区'},  
            {field: 'street', title: '街道'},  
            // 设置表头工具栏  
            {field: '操作', toolbar: '#operateBar'}  
         ]]      });  
  
      /**  
       * 监听行工具栏事件  
       */  
      table.on('tool(addressTable)', function (obj) {  
         // 得到当前操作行的相关信息  
         var tr = obj.data;  
         console.log("tr:" + JSON.stringify(tr));  
         // 得到事件名  
         var eventName = obj.event;  
         console.log(eventName)  
  
  
         // 判断事件名，执行对应方法  
         if (eventName === 'del') { // 删除  
            layer.confirm("你确认要删除么？", function (index) {  
               $.ajax({  
                  type: "POST",  
                  url: "/deleteAddress",  
                  data: JSON.stringify(tr.aid),  
                  dataType: "json",  
                  contentType: "application/json;charset=UTF-8",  
                  success: function (data) {  
                     if (data === true) {  
                        // 删除指定tr del()  
                        obj.del();  
                     }  
                  }               
               });  
               // 关闭弹出层（index是当前弹出层的下标）  
               layer.close(index);  
            })  
         } else if (eventName === 'edit') { // 编辑  
            layer.open({  
               type: 2,  
               area: ['700px', '550px'],  
               fixed: true, //不固定  
               maxmin: false,  
               title: '新增收货地址',  
               anim:1,  
               shadeClose:true,  
               content: '/shouhuoUpdate',  
               success: function (layero, index) {  
                  var body = layer.getChildFrame('body', index);  
                  var aidEle = body.find("#aid");  
                  aidEle.val(tr.aid)  
                  var realNameEle = body.find("#userName");  
                  realNameEle.val(tr.realname);  
                  var mobileEle = body.find("#mobile");  
                  mobileEle.val(tr.mobile);  
                  var provinceEle = body.find("#province");  
                  provinceEle.val(tr.province)  
                  var cityEle = body.find("#city");  
                  cityEle.val(tr.city);  
                  var zoneEle = body.find("#zone");  
                  zoneEle.val(tr.zone)  
                  var streetEle = body.find("#street");  
                  streetEle.val(tr.street)  
                  // 重新渲染表单  
                  form.render();  
               }  
            });  
         }  
      })   });  
</script>
```

### 购买商品

##### 获取被购买商品相关数据

```js
//结算按钮  
$("#buyBtn").click(function(){  
   var sum = 0;  
   var buyItems = [];  
   var selectCheck = document.getElementsByName("selectedItem");  
   for (let i = 0; i < selectCheck.length; i++) {  
      if (selectCheck[i].checked) {  
         var sumCurrent = parseInt($('#sum' + selectCheck[i].value).text());  
         var uid = [[${session.loginUser != null ? session.loginUser.uid : null}]];  
         sum = sum + sumCurrent;  
         var cart = {  
            'cid': parseInt(selectCheck[i].value),  
            'uid': parseInt(uid),  
            'id': parseInt($('#id' + selectCheck[i].value).text()),  
            'name': $('#name' + selectCheck[i].value).text(),  
            'price': parseInt($('#price' + selectCheck[i].value).text()),  
            'buynum': parseInt($("#opt" + selectCheck[i].value).children("input").val()),  
            'sum': sumCurrent,  
            'pic': $('#pic' + selectCheck[i].value)[0].src  
         }  
         buyItems.push(cart)  
      }   
   }   
	
	var data = {  
      'buyItems': buyItems,  
      'sum': sum  
   }  
	
   console.log(JSON.stringify(data))  
   $.ajax({  
      type: "POST",  
      url: "/payCart",  
      data: JSON.stringify(JSON.stringify(data)),  
      contentType: "application/json;charset=UTF-8",  
      success : function () {  
         window.location.href="/buy"  
      }  
   });  
});
```
##### 点击购买按钮

```html
<button id="buyBtn">去付款</button>
```

```js
$("#buyBtn").click(function(){  
    var aid = $(".sel").attr('id');  
    var oid = [[${session.oid}]]  
    console.log(aid);  
    if (aid != null) {  
        location.href = "/pay/" + aid + "/" + oid;  
    } else {  
        swal("警告", "请选择一个收件人", "warning")  
    }  
});
```

## 总结与展望

虽然这个项目的后台部分我没有写，但是我自己确确实实在这个项目上花了很多的时间，同样的写这个项目带给我个人的成长也很大。

- 在上学期写的项目中，我们写那个小说网站的时候，发送给后台发送Http请求多用的都是a标签发送gei请求，表单发送post请求，在写这次的小米商城项目中，我多半的请求发送都是用的Ajax，用Ajax发送请求后，用js代码来对页面上的元素进行更新，来达到页面==部分更新==的效果。
- 在写这次的项目的过程中，我也对LayUI做了一个大致的了解，作为一款为后端程序员而开发的前端框架，用LayUI来快速构建前端页面真的非常的方便，在这次的项目中，我使用得较多的就是LayUI的弹出层和数据表格。
- 在这次的项目中，我深深的体会到，用json格式的数据来进行前后台的数据交互真的非常的方便。前台发送给来的json数据，用类似fastjson的第三方工具包，可以很方便的映射到后台的javaBean中。
- 同时，我也用到了Thymeleaf中很多比较灵活的用法，比如通过模板给js函数多态传参，通过Thymeleaf的javascript内联语法，可以在javascript代码中直接获取Thymeleaf中所存的域对象的值。

下面说说这个项目的一些不足之处：

- 没写后台，这个是真的来不及写，其实后台的细节很多，想写一个好的后台，花的时间不会比前台花的时间少。
- 现在主流的开发是用的前后端分离，在写这个项目之前，我想过用前后端分离来写，老师上课提过的art-template，之前看文档发现都是在node.js里面用，在纯静态页面中，我不知道怎么搞。后面我会多找找相关资料，尝试用art-template去写一些东西。

## 参考

- window.location.href的用法:https://blog.csdn.net/u011010220/article/details/114871948
- String转String数组转int数组转List「Integer」:https://blog.csdn.net/qq_42969135/article/details/107228423 
- 『Layui』弹出层（从父窗口传递数据到子窗口）:https://blog.csdn.net/Code_shadow/article/details/80524633
- 『LayUI』表格部分可编辑：[(114条消息) layui Table设置可编辑控制_colouful_2021的博客-CSDN博客_layui可编辑表格](https://blog.csdn.net/weixin_43343835/article/details/117477566?spm=1001.2101.3001.6650.6&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-6-117477566-blog-103959182.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-6-117477566-blog-103959182.pc_relevant_aa&utm_relevant_index=9)