# Web开发之 HTTPS 证书校验
## 关于SSL证书双向认证的原理过程
HTTPS是工作于SSL层之上的HTTP协议，SSL（安全套接层）工作于TCP层之上，向应用层提供了两个基本安全服务：认证和保密。SSL有三个子协议：握手协议，记录协议和警报协议。其中握手协议实现服务器与客户端的认证与密钥交换，记录协议进行数据加密并保证数据的完整性，警报协议则规定了错误类型和处理机制。

SSL握手协议包含4个阶段，下面简单介绍每个阶段。

双向认证 SSL 协议的具体过程：

![](https://pic4.zhimg.com/80/v2-6528a47e1ec49f81171b034bea94827f_720w.webp)

1. 浏览器发送一个连接请求给安全服务器。
2. 服务器将自己的证书，以及同证书相关的信息发送给客户浏览器。
3.  客户浏览器检查服务器送过来的证书是否是由自己信赖的 CA 中心所签发的。如果是，就继续执行协议；如果不是，客户浏览器就给客户一个警告消息：警告客户这个证书不是可以信赖的，询问客户是否需要继续。
4. 接着客户浏览器比较证书里的消息，例如域名和公钥，与服务器刚刚发送的相关消息是否一致，如果是一致的，客户浏览器认可这个服务器的合法身份。
5.  服务器要求客户发送客户自己的证书。收到后，服务器验证客户的证书，如果没有通过验证，拒绝连接；如果通过验证，服务器获得用户的公钥。
6.  客户浏览器告诉服务器自己所能够支持的通讯对称密码方案
7.  服务器从客户发送过来的密码方案中，选择一种加密程度最高的密码方案，用客户的公钥加过密后通知浏览器。
8. 浏览器针对这个密码方案，选择一个通话密钥，接着用服务器的公钥加过密后发送给服务器。
9. 服务器接收到浏览器送过来的消息，用自己的私钥解密，获得通话密钥。
10. 服务器、浏览器接下来的通讯都是用对称密码方案，对称密钥是加过密的。

上面所述的是双向认证 SSL 协议的具体通讯过程，这种情况要求服务器和用户双方都有证书。

## SSL 双向认证的例子
首先创建服务器端私有密钥和公共密钥

```
1, keytool -genkey -alias clientkey -keystore kserver.ks  
密码: serverpass  
2, keytool -export -alias serverkey -keystore kserver.ks -file server.crt  
3, keytool -import -alias serverkey -file server.crt -keystore tclient.ks  
密码: clientpublicpass
```

下面创建客户器端私有密钥和公共密钥

```
1, keytool -genkey -alias clientkey -keystore kclient.ks  
密码: clientpass  
2, keytool -export -alias clientkey -keystore kclient.ks -file client.crt  
3, keytool -import -alias clientkey -file client.crt -keystore tserver.ks  
密码: serverpublicpass
```

把服务器端产生的公共密钥放到客户端, 同样把客户端创建的公共密钥放到服务器端。

常见的HTTPS传输, 不需要进行客户端认证, 也就是单向认证. 这时也就不需要创建客户端的私钥和公钥. 服务器端也只要配置一下服务器端的私钥即可, 当客户端浏览器访问时会生成一个证书文件,类似于上面创建的crt文件. 如果需要程序访问,可以通过这个crt文件生成一个keystore. 然后是用这个keystore作为trust keystore即可。
## TLS 证书校验
[HTTPS 精读之 TLS 证书校验 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/30655259)

## HTTPS 是如何工作的
你可以认为一个 TLS 连接发生在两个阶段。第一个阶段是握手，在这个阶段客户端验证服务器是可以信任的并且生成一些 TLS session key。第二个阶段是实际的数据传输，在这个阶段数据被使用握手阶段生成的 TLS session key 加密并且签名。

总的来说，它是这样工作的：

1. 一个 TCP 连接被建立并且 TLS 握手开始。客户端发送给服务器一系列的它所支持的 TLS 版本和加密套件（一个加密套件本质上是一个描述连接中应该使用的，描述不同加密算法的标识符）。
2. web服务器发送给客户端它所选择的 TLS 版本和加密套件的确认，从这开始，准确的过程依赖于所选择的加密套件。但是处于解释的目的我假设加密套件 `TLS_RSA_WITH_AES_128_GCM_SHA256` 被使用。
3. 加密套件的第一部分指明了使用的密钥交换算法（在这个例子中是 RSA）。这个 Web 服务器发送它的 TLS 证书（包含 RSA 公钥）。这个客户端然后验证 TLS 证书没有失效并且是被信任的。Web 浏览器已经安装了所有的主流的证书授权机构的公钥，它们可以被使用去验证这个 Web 服务器的证书确实是被信任的证书授权机构所签名。客户端也确认 TSL 证书中的主机是对它有一个开放的连接。
4. 客户端生成 secret session keys。它使用服务端的 RSA 公钥进行加密（来自 TLS certificate）并且把它们发送给 web 服务器，服务器私用他们的 RSA 私钥进行解密。这就是所谓的「密码交换」。客户端和服务器现在都可以访问相同的 session keys，并且没有其他的人应该知道它们（指 session key），TLS 握手到此结束。
5. 实际数据的传输现在准备开始了